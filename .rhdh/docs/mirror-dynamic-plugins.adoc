== Mirroring Red Hat Developer Hub Dynamic Plugins for Disconnected Environments

Red Hat Developer Hub (RHDH) uses dynamic plugins that are distributed as OCI (Open Container Initiative) artifacts. In disconnected or restricted environments, these plugin artifacts must be mirrored to a registry accessible by your cluster.

This guide explains how to use the link:./../scripts/mirror-plugins.sh[mirror-plugins.sh] script to mirror dynamic plugin OCI artifacts for deployments in restricted environments.

=== Prerequisites

The following tools are required to run the mirroring script:

* `skopeo >= 1.20` - For multi-arch image operations and manifest conversion. See link:https://github.com/containers/skopeo/blob/main/install.md[Installing Skopeo].
* `tar >= 1.35` - GNU tar for extracting image layers.
* `jq >= 1.7` - For JSON parsing and manipulation. See link:https://jqlang.github.io/jq/download/[Download jq].
* `podman >= 5.6` - For building catalog index images. See link:https://podman.io/docs/installation[Podman Installation Instructions].
* You have authenticated to the source registry (for example, `quay.io` or `registry.redhat.io`) for pulling plugin artifacts. See link:https://access.redhat.com/articles/RegistryAuthentication[Red Hat Container Registry Authentication].
* When mirroring directly to a registry (using `--to-registry`), you have authenticated to the target registry.

=== Procedures

[#_mirroring_all_plugins_from_catalog_index]
==== Mirroring all plugins from a catalog index (Partially disconnected environment)

Run the mirroring script with the catalog index (replace `1.9` with your desired RHDH version):

[source,console]
----
bash mirror-plugins.sh \
    --plugin-index oci://quay.io/rhdh/plugin-catalog-index:1.9 \
    --to-registry registry.example.com
----

[#_fully_disconnected_workflow]
==== Mirroring to a fully disconnected environment

This two-phase process exports plugins to disk from a connected host, transfers them to a restricted network, then imports them to your internal registry.

*Phase 1: Export plugins (Connected Host)*

Export all plugins to a local directory:

[source,console]
----
bash mirror-plugins.sh \
    --plugin-index oci://quay.io/rhdh/plugin-catalog-index:1.9 \
    --to-dir /tmp/rhdh-plugins
----

Transfer the `/tmp/rhdh-plugins` directory to your restricted network environment.

*Phase 2: Import plugins (Restricted Network Environment)*

Import and push the plugins to your internal registry:

[source,console]
----
bash mirror-plugins.sh \
    --from-dir /tmp/rhdh-plugins \
    --to-registry internal-registry.example.com
----

[#_mirroring_specific_plugins]
==== Mirroring specific plugins by direct reference

Mirror individual plugins by specifying their OCI URLs directly:

[source,console]
----
bash mirror-plugins.sh \
    --plugins 'oci://quay.io/rhdh-plugin-catalog/backstage-community-plugin-quay:1.8.0--1.22.1!backstage-community-plugin-quay' \
              'oci://quay.io/rhdh-plugin-catalog/backstage-community-plugin-github-actions:1.8.0--0.11.1!backstage-community-plugin-github-actions' \
    --to-registry registry.example.com
----

NOTE: Plugin URLs containing `!` (OCI subpath) must be quoted to prevent shell interpretation.

[#_mirroring_from_plugin_list_file]
==== Mirroring plugins from a file

Create a text file listing the plugins to mirror (one per line):

.Example plugins.txt
[source,text]
----
# Production RHDH Plugins
oci://quay.io/rhdh-plugin-catalog/backstage-community-plugin-quay:1.8.0--1.22.1!backstage-community-plugin-quay
oci://quay.io/rhdh-plugin-catalog/backstage-community-plugin-github-actions:1.8.0--0.11.1!backstage-community-plugin-github-actions
oci://quay.io/rhdh-plugin-catalog/backstage-community-plugin-azure-devops:1.8.0--0.8.2!backstage-community-plugin-azure-devops
----

Mirror the plugins from the file:

[source,console]
----
bash mirror-plugins.sh \
    --plugin-list plugins.txt \
    --to-registry registry.example.com
----

[#_mixed_mode_catalog_and_custom_plugins]
==== Mixed mode: Combining multiple plugin sources

You can combine any of the plugin sources (catalog index, plugin list file, and direct URLs) in a single mirroring operation. The script automatically deduplicates plugins if the same plugin appears in multiple sources.

[source,console]
----
bash mirror-plugins.sh \
    --plugin-index oci://quay.io/rhdh/plugin-catalog-index:1.9 \
    --plugin-list custom-plugins.txt \
    --plugins 'oci://registry.internal.example.com/custom/my-plugin:1.0' \
    --to-registry registry.example.com
----

=== Using mirrored plugins

After mirroring completes, the script generates a `rhdh-plugin-mirroring-summary.txt` file containing mappings of all mirrored plugins. Use this file to reference the correct mirrored plugin URLs when configuring your RHDH deployment.

For Operator deployments, configure the `Backstage` Custom Resource with the mirrored plugin references. For Helm deployments, update your values file with the mirrored plugin references. See link:https://docs.redhat.com/en/documentation/red_hat_developer_hub/1.8/html/installing_and_viewing_plugins_in_red_hat_developer_hub/assembly-third-party-plugins#proc-load-plugin-oci-image_assembly-install-third-party-plugins-rhdh[Red Hat Developer Hub Documentation] for configuration details.
